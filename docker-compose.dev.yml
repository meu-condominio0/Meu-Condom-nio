version: "3.9"

services:
  mysql:
    image: mysql:8.0
    container_name: condominio_db_dev
    restart: always

    env_file:
      - .env.db

    ports:
      - "3308:3306"

    volumes:
      - condominio_data:/var/lib/mysql

    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 20
      start_period: 40s

  backend:
    container_name: backend_dev
    build:
      context: ./backendpy
      dockerfile: Dockerfile

    # â— REMOVE O .sh (agora o Dockerfile jÃ¡ chama wait_for_db.py)
    command: >
      sh -c "
        echo 'ðŸ”§ Aguardando MySQL iniciar...';
        python3 app/wait_for_db.py &&
        uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
      "

    ports:
      - "8000:8000"

    env_file:
      - ./backendpy/.env.docker

    environment:
      - DOCKER_ENV=true

    depends_on:
      mysql:
        condition: service_healthy

    volumes:
      - ./backendpy/app:/app/app
      - ./backendpy:/app

  frontend:
    container_name: frontend_dev
    build:
      context: .
      dockerfile: Dockerfile.dev

    command: ["npm", "run", "dev"]

    ports:
      - "5173:5173"

    volumes:
      - ./:/app
      - /app/node_modules

    depends_on:
      - backend

volumes:
  condominio_data:
